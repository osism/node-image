#cloud-config
autoinstall:
  version: 1

  ssh:
    allow-pw: true
    install-server: true

  identity:
    hostname: osism
    password: "$5$H2wkOHUVMIm2Yl2n$2AR/A2ILtgZcWx5UXL6N56Ha/wkdGvs0w5sFUMQ3iaB"
    username: ubuntu

  packages:
    - ca-certificates
    - curl
    - git
    - wget

  network:
    network:
      version: 2
      ethernets:
        alleths:
          match:
            name: en*
          dhcp4: true
          optional: true

  storage:
    config:
      - grub_device: false
        id: disk-sda
        name: ''
        path: /dev/sda
        preserve: false
        ptable: gpt
        type: disk
        wipe: superblock-recursive
      - grub_device: false
        id: disk-sdb
        name: ''
        path: /dev/sdb
        preserve: false
        ptable: gpt
        type: disk
        wipe: superblock-recursive
      - device: disk-sdb
        flag: boot
        grub_device: true
        id: partition-0
        number: 1
        preserve: false
        size: 1127219200
        type: partition
        wipe: superblock
      - fstype: fat32
        id: format-0
        preserve: false
        type: format
        volume: partition-0
      - device: disk-sdb
        flag: ''
        grub_device: false
        id: partition-1
        number: 2
        preserve: false
        size: 1073741824
        type: partition
        wipe: superblock
      - fstype: ext4
        id: format-1
        preserve: false
        type: format
        volume: partition-1
      - device: disk-sda
        flag: ''
        grub_device: false
        id: partition-2
        number: 1
        preserve: false
        size: 1073741824
        type: partition
      - device: disk-sda
        flag: ''
        grub_device: false
        id: partition-3
        number: 2
        preserve: false
        size: 1127219200
        type: partition
      - device: disk-sdb
        flag: swap
        grub_device: false
        id: partition-4
        number: 3
        preserve: false
        size: 8589934592
        type: partition
        wipe: superblock
      - fstype: swap
        id: format-2
        preserve: false
        type: format
        volume: partition-4
      - device: format-2
        id: mount-2
        path: ''
        type: mount
      - device: disk-sda
        flag: swap
        grub_device: false
        id: partition-5
        number: 3
        preserve: false
        size: 8589934592
        type: partition
        wipe: superblock
      - fstype: swap
        id: format-3
        preserve: false
        type: format
        volume: partition-5
      - device: format-3
        id: mount-3
        path: ''
        type: mount
      - device: disk-sdb
        flag: ''
        grub_device: false
        id: partition-6
        number: 4
        preserve: false
        size: -1
        type: partition
        wipe: superblock
      - device: disk-sda
        flag: ''
        grub_device: false
        id: partition-7
        number: 4
        preserve: false
        size: -1
        type: partition
        wipe: superblock
      - devices:
          - partition-6
          - partition-7
        id: raid-0
        name: md0
        preserve: false
        raidlevel: raid1
        spare_devices: []
        type: raid
        wipe: superblock
      - devices:
          - raid-0
        id: lvm_volgroup-0
        name: system
        preserve: false
        type: lvm_volgroup
      - id: lvm_partition-0
        name: root
        preserve: false
        size: 10GB
        type: lvm_partition
        volgroup: lvm_volgroup-0
        wipe: superblock
      - fstype: ext4
        id: format-5
        preserve: false
        type: format
        volume: lvm_partition-0
      - device: format-5
        id: mount-5
        path: /
        type: mount
      - device: format-1
        id: mount-1
        path: /boot
        type: mount
      - device: format-0
        id: mount-0
        path: /boot/efi
        type: mount

      - id: lv-system-home
        type: lvm_partition
        name: home
        size: 10GB
        wipe: superblock-recursive
        volgroup: lvm_volgroup-0

      - id: lv-system-tmp
        type: lvm_partition
        name: tmp
        size: 10GB
        wipe: superblock-recursive
        volgroup: lvm_volgroup-0

      - id: lv-system-var
        type: lvm_partition
        name: var
        size: 10GB
        wipe: superblock-recursive
        volgroup: lvm_volgroup-0

      - id: lv-system-log
        type: lvm_partition
        name: log
        size: 10GB
        wipe: superblock-recursive
        volgroup: lvm_volgroup-0

      - id: lv-system-audit
        type: lvm_partition
        name: audit
        size: 1GB
        wipe: superblock-recursive
        volgroup: lvm_volgroup-0

      - id: lv-system-docker
        type: lvm_partition
        name: docker
        size: 60GB
        wipe: superblock-recursive
        volgroup: lvm_volgroup-0

      - {id: format-home, type: format, fstype: ext4, volume: lv-system-home}
      - {id: format-tmp, type: format, fstype: ext4, volume: lv-system-tmp}
      - {id: format-var, type: format, fstype: ext4, volume: lv-system-var}
      - {id: format-log, type: format, fstype: ext4, volume: lv-system-log}
      - {id: format-audit, type: format, fstype: ext4, volume: lv-system-audit}
      - {id: format-docker, type: format, fstype: ext4, volume: lv-system-docker}

      - {device: format-home, path: /home, type: mount, id: mount-home}
      - {device: format-tmp, path: /tmp, type: mount, id: mount-tmp}
      - {device: format-var, path: /var, type: mount, id: mount-var}
      - {device: format-log, path: /var/log, type: mount, id: mount-log}
      - {device: format-audit, path: /var/log/audit, type: mount, id: mount-audit}
      - {device: format-docker, path: /var/lib/docker, type: mount, id: mount-docker}

  late-commands:
    - echo osism-$(openssl rand -hex 3) > /target/etc/hostname
    - echo "Ubuntu 22.04 LTS \nIP - $(hostname -I)\n" > /target/etc/issue
    # shut-down the host to avoid an infinite installer loop
    - shutdown -h now

  user-data:
    disable_root: true
    timezone: Etc/UTC
    package_update: true
    package_upgrade: true
    packages:
      - containerd.io
      - docker-ce
      - docker-ce-cli
      - docker-compose-plugin
      - file
      - frr
      - htop
      - lldpd
      - procps
      - python3
      - vim
      - whois
    apt:
      primary:
        - arches: [default]
          uri: http://de.archive.ubuntu.com/ubuntu/
      sources:
        docker.list:
          source: deb [arch=amd64] https://download.docker.com/linux/ubuntu jammy stable
          keyid: 9DC858229FC7DD38854AE2D88D81803C0EBFCD88
    runcmd:
      - apt purge --yes snapd modemmanager lxd-agent-loader
      - apt purge --yes plymouth plymouth-theme-ubuntu-text
      - apt purge --yes ubuntu-advantage-tools xauth landscape-common btrfs-progs
      - apt purge --yes apport apport-symptoms open-vm-tools ntfs-3g
      - apt purge --yes telnet pastebinit tnftp ftp open-iscsi bolt packagekit
      - apt autoremove --yes --purge
      - systemctl disable apt-daily-upgrade.timer
      - systemctl disable apt-daily.timer
      - systemctl disable motd-news.timer
      - systemctl disable unattended-upgrades.service
      - dd if=/dev/sda1 of=/dev/sdb1
      - efibootmgr -c -d /dev/sdb -p 1 -L "ubuntu2" -l "\EFI\UBUNTU\GRUBX64.EFI"
      - efibootmgr -c -d /dev/sdb -p 1 -L "ubuntu2" -l "\EFI\UBUNTU\SHIMX64.EFI"
    # shutdown after first host initial provisioning
    power_state:
      mode: poweroff
