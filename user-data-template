#cloud-config
autoinstall:
  version: 1

  ssh:
    allow-pw: true
    install-server: true

  identity:
    hostname: osism
    password: "$5$H2wkOHUVMIm2Yl2n$2AR/A2ILtgZcWx5UXL6N56Ha/wkdGvs0w5sFUMQ3iaB"
    username: osism

  network:
    network:
      version: 2
      ethernets:
        alleths:
          match:
            name: en*
          dhcp4: false
          optional: true

  storage:
    config: !include include.d/disk-layout.yml

  late-commands:
    - mkdir /target/frr-files
    - cp /cdrom/frr-files/* /target/frr-files
    - curtin in-target --target=/target -- bash -c "dpkg -i /frr-files/*.deb"
    - curtin in-target -- /frr-files/install.sh | tee /var/log/installer/frr.log
    - tar cf /target/install.log.tar /var/log/installer

    # shut-down the host to avoid an infinite installer loop
    - shutdown -h now

  user-data:
    disable_root: true
    timezone: Etc/UTC
    package_update: true
    package_upgrade: true
    packages:
      - ca-certificates
      - curl
      - file
      - frr
      - git
      - htop
      - ipmitool
      - jq
      - linux-generic-hwe-22.04
      - lldpd
      - procps
      - python3
      - vim
      - wget
      - whois

    apt:
      primary:
        - arches: [default]
          uri: http://de.archive.ubuntu.com/ubuntu/

    runcmd:
      - !include include.d/runcmd-default.yml
      - !include include.d/runcmd.yml

    # shutdown after first host initial provisioning
    power_state:
      mode: poweroff
