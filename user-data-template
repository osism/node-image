#cloud-config
autoinstall:
  version: 1

  ssh:
    allow-pw: true
    install-server: true

  identity:
    hostname: osism
    password: "$5$H2wkOHUVMIm2Yl2n$2AR/A2ILtgZcWx5UXL6N56Ha/wkdGvs0w5sFUMQ3iaB"
    username: ubuntu

  packages:
    - ca-certificates
    - curl
    - git
    - wget

  network:
    network:
      version: 2
      ethernets:
        alleths:
          match:
            name: en*
          dhcp4: true
          optional: true

  storage:
    config: !include include.d/disk-layout-1.yml

  late-commands:
    - echo osism-$(openssl rand -hex 3) > /target/etc/hostname
    - echo "Ubuntu 22.04 LTS \nIP - $(hostname -I)\n" > /target/etc/issue
    # shut-down the host to avoid an infinite installer loop
    - shutdown -h now

  user-data:
    disable_root: true
    timezone: Etc/UTC
    package_update: true
    package_upgrade: true
    packages:
      - containerd.io
      - docker-ce
      - docker-ce-cli
      - docker-compose-plugin
      - file
      - frr
      - htop
      - procps
      - python3
      - vim
      - whois
    apt:
      primary:
        - arches: [default]
          uri: http://de.archive.ubuntu.com/ubuntu/
      sources:
        docker.list:
          source: deb [arch=amd64] https://download.docker.com/linux/ubuntu jammy stable
          keyid: 9DC858229FC7DD38854AE2D88D81803C0EBFCD88
    runcmd:
      - apt purge --yes snapd modemmanager lxd-agent-loader
      - apt purge --yes plymouth plymouth-theme-ubuntu-text
      - apt purge --yes ubuntu-advantage-tools xauth landscape-common btrfs-progs
      - apt purge --yes apport apport-symptoms open-vm-tools ntfs-3g
      - apt purge --yes telnet pastebinit tnftp ftp open-iscsi bolt packagekit
      - apt autoremove --yes --purge
      - systemctl disable apt-daily-upgrade.timer
      - systemctl disable apt-daily.timer
      - systemctl disable motd-news.timer
      - systemctl disable unattended-upgrades.service
      - dd if=/dev/sda1 of=/dev/sdb1
      - efibootmgr -c -d /dev/sdb -p 1 -L "ubuntu2" -l "\EFI\UBUNTU\GRUBX64.EFI"
      - efibootmgr -c -d /dev/sdb -p 1 -L "ubuntu2" -l "\EFI\UBUNTU\SHIMX64.EFI"
    # shutdown after first host initial provisioning
    power_state:
      mode: poweroff
